# Trivy 보안 점검과 feedparser를 통한 블로그 글 수집 자동화 with GitHub Actions

저는 제 프로필 readme에 올라가있는 최신블로그 글 가져오기를 gitAction 으로 올려둔 상태인데 해당 워크플로우를 빌드하여 이미지로 만든뒤 취약점을 분석해 보겠습니다. 

## 0. Trivy 란

- 취약점을 간단히 스캔할 수 있는 도구

컨테이너 이미지, 파일 시스템 및 Git 리포지토리의 취약점, 미설정 구성 문제에 대한 다양한 진단을 제공

## 1. 도커 컨테이너로 Trivy 설치

컨테이너를 사용해서 설치하면 호환성 등의 문제 없이 1분내로 Trivy를 구성

```bash
docker run --rm -v trivy-cache:/root/.cache/ -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest

```

- `-v` 옵션을 사용해 캐시 디렉토리를 마운트

이 명령을 사용하면 다운로드 후 Trivy가 자동으로 실행되며 도움말이 출력 

- `--rm` 옵션이 설정되어 있어 실행 후에는 컨테이너가 자동으로 삭제

## 2. 취약성을 검사할 파이썬 앱 코드 생성

저는 제 프로필 `README.md`에 올라가 있는 제 최신 블로그 글(5개)을 가져오기 위해 GitHub Actions를 설정했습니다. 

이를 자정에 업데이트되도록 Cron 식을 사용하고, 파이썬 코드를 통해 실행할 것입니다. 

 Flask를 통해 이 과정이 정상적으로 작동하는지 테스트해보겠습니다.

먼저 파일 구조는 다음과 같습니다. 

```bash
.
├── app.py
├── Dockerfile
└── requirements.txt
└── .github
		└── workflows
		    └── python-app.yml

```

- Tistory 블로그의  최신 블로그 포스트를 파싱
- 최대 5개의 포스트를 HTML 형식으로 리스트에 추가하여 웹 페이지로 반환

```bash
# app.py
from flask import Flask
import feedparser

app = Flask(__name__)

@app.route('/')
def home():
    hongminyeong_blog_rss_url = "https://0boss.tistory.com/rss"
    rss_feed = feedparser.parse(hongminyeong_blog_rss_url)

    MAX_POST_NUM = 5
    latest_blog_post_list = ""

    for idx, feed in enumerate(rss_feed['entries']):
        if idx >= MAX_POST_NUM:
            break
        feed_date = feed['published_parsed']
        latest_blog_post_list += f"<li>{feed_date.tm_year}.{feed_date.tm_mon}.{feed_date.tm_mday} - <a href='{feed['link']}'>{feed['title']}</a></li>\n"

    return f"<h1>Latest Blog Posts</h1><ul>{latest_blog_post_list}</ul>"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)

```

## 3. 의존성 추가

```bash
Flask==2.0.1
feedparser==6.0.8
```

## 4. 깃액션 워크플로우 yml 파일 추가

`.github/workflows/python-app.yml` 파일을 다음과 같이 작성합니다. 

- **이름 및 트리거 설정**: `main` 브랜치에 push || pull request가 발생하거나, 매일 자정에 업데이트
- **빌드 작업**:
    - **환경 설정**: Ubuntu
    - **Python 설정**: Python 3.9 설치.
    - **의존성 설치**: 필요한 패키지 설치.
    - **Docker 이미지 빌드**: Flask 앱의 Docker 이미지 생성.
    - **Docker 컨테이너 실행**: 빌드된 이미지를 사용하여 컨테이너 실행.
    - **취약성 검사**: Trivy를 사용하여 컨테이너의 취약성 검사.
    - **정리 작업**: 실행 중인 컨테이너를 정지하고 삭제.

저의 귀여운 대략적 워크 플로우입니다.

github 에서 readme 파일 수정하거나 자정에 워크플로우가 진행됩니다. 
![2501](https://github.com/user-attachments/assets/6892c832-9f89-4cfa-80b3-2620f84cd436)

DockerHub 에 push 할때마다 태그 번호를 1씩 증가시켰습니다. 


```bash
# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Python application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
   - cron: "0 0 */1 * *"
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
       python -m pip install --upgrade pip
        pip install feedparser
    - name: Run Update Python Script
      run: |
        python HongMinyeong.py ## 실행시킬 .py이름
    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u hongminyeong --password-stdin
      
    - name: Get the latest tag
      id: get_latest_tag
      run: |
        echo "Fetching latest tag..."
        TAG=$(curl -s https://hub.docker.com/v2/repositories/hongminyeong/pythonapp/tags | jq -r '.results[0].name' | sed 's/[^0-9]*//g')
        echo "Latest tag: $TAG"
        if [[ -z "$TAG" ]]; then
          echo "TAG=0" >> $GITHUB_ENV
        else
          echo "TAG=$TAG" >> $GITHUB_ENV
        fi
    - name: Set new tag
      id: set_new_tag
      run: |
        NEW_TAG=$((TAG + 1))
        echo "New tag: $NEW_TAG"
        echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

    - name: Build Docker Image
      run: |
        docker build -t myflaskapp .
        docker tag myflaskapp hongminyeong/pythonapp:${{ env.NEW_TAG }}
        docker push hongminyeong/pythonapp:${{ env.NEW_TAG }}

    - name: Run Trivy Vulnerability Scan
      run: |
        docker run --rm -v $(pwd):/project aquasec/trivy --quiet --severity HIGH,CRITICAL filesystem /project
        docker run --rm aquasec/trivy image hongminyeong/pythonapp:${{ env.NEW_TAG }}
        
    - name: Update README.md file
      run: |
        git pull
        git add .
        git diff
        git config --local user.email "minyung1240@daum.nat"
        git config --local user.name "HongMinyeong"
        git commit -m "Update README.md"
        git push
```

## 5. 도커 이미지 빌드

```bash
docker build -t pythonapp.
```


## 6. 컨테이너 실행

```bash
$ docker run --name mycontainer -d -p 80:5000 pythonapp
```

## 7. 애플리케이션 테스트

```bash
$ curl http://localhost:80
```

visual studio code 로 확인했을 때 의도한대로 잘 나오는 모습입니다. 

![2502](https://github.com/user-attachments/assets/3b63dbcd-cde4-4eb9-8cb3-a02404cf9003)


## 8. 도커 허브에  이미지 push 하기

```bash
$ docker push hongminyeong/pythonapp:1.0
```

## 9. trivy 실행 - ubuntu linux cli

다음 명령어로 Trivy를 실행하여 취약성을 검사합니다.

```bash
$ docker run --rm aquasec/trivy image hongminyeong/pythonapp:1.0
```

저의 image는 좋지않은 취약심각성을 확인할 수 있습니다. ㅎㅎ^^*
![2503](https://github.com/user-attachments/assets/0d43c4d8-5268-4345-8782-70000715cfb7)


## 10. 결론

Trivy를 사용하여 컨테이너 이미지의 취약성을 검사하는 과정은 매우 간단하고 효과적입니다.

 위의 단계들을 통해 Flask 애플리케이션을 만들고, 이를 Docker 이미지로 패키징한 후, 취약성 스캔을 수행했습니다.

 Trivy는 높은 심각도를 가진 취약점을 식별해 주며, 이러한 정보를 바탕으로 보안 문제를 해결하고 애플리케이션을 개선할 수 있습니다.

개발 과정에서 보안을 고려하는 것은 필수적이며, Trivy와 같은 도구를 사용하여 정기적으로 취약성을 점검하는 습관을 기르는 것이 중요합니다.

 앞으로도 이러한 도구들을 활용하여 안전하고 신뢰할 수 있는 소프트웨어 개발을 지속해 나갈 것입니다.
